#!/bin/bash

# Nautilus script to convert images to AVIF format
# Uses ImageMagick for conversion

for file in "$@"; do
    # Check if the file is an image
    if [[ "$(file -b --mime-type "$file")" =~ ^image/ ]]; then
        
        # Extract filename without extension
        base="${file%.*}"
        
        # Generate output filename with .avif extension
        output="${base}.avif"
        
        # Check if output file already exists
        if [[ -f "$output" ]]; then
            # Ask user if they want to overwrite
            zenity --question --text="File $output already exists. Overwrite?" \
                   --title="File Exists"
            if [[ $? -ne 0 ]]; then
                continue  # Skip if user says no
            fi
        fi
        
        # Convert to AVIF with quality setting (AVIF quality 30-80 is recommended)
        # Note: AVIF quality scale is different from WebP/JPEG
        if convert "$file" -quality 70 "$output"; then
            notify-send "Conversion Successful" \
                "Converted $(basename "$file") to AVIF"
        else
            zenity --error --text="Failed to convert $(basename "$file")\n\nMake sure your ImageMagick supports AVIF:\nsudo apt install libavif-dev"
        fi
    else
        zenity --warning --text="$(basename "$file") is not a valid image file"
    fi
done
