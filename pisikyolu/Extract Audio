#!/bin/bash

# Nautilus script to extract audio from video files as low-quality MP3
# Supported formats: mp4, mkv, avi, mov, flv, wmv, webm, m4v, mpg, mpeg

# Set output directory (same as input by default)
OUTPUT_DIR="$PWD"

# Function to extract audio from a single file
extract_audio() {
    local input_file="$1"
    local filename=$(basename "$input_file")
    local basename="${filename%.*}"
    local output_file="${OUTPUT_DIR}/${basename}.mp3"
    
    # Check if output file already exists
    if [ -f "$output_file" ]; then
        local counter=1
        while [ -f "${OUTPUT_DIR}/${basename}_${counter}.mp3" ]; do
            counter=$((counter + 1))
        done
        output_file="${OUTPUT_DIR}/${basename}_${counter}.mp3"
    fi
    
    echo "Processing: $filename"
    
    # Extract audio with low quality settings (64k mono)
    ffmpeg -i "$input_file" \
        -vn \
        -acodec libmp3lame \
        -ac 1 \
        -ar 22050 \
        -ab 64k \
        -y \
        "$output_file" 2>/dev/null
    
    if [ $? -eq 0 ]; then
        echo "✓ Created: $(basename "$output_file")"
    else
        echo "✗ Failed to process: $filename"
        # Remove failed output file if created
        [ -f "$output_file" ] && rm "$output_file"
    fi
}

# Main script
echo "=========================================="
echo "Extracting Audio as Low Quality MP3"
echo "=========================================="

# Count selected files
file_count=0
processed_count=0

# Process each selected file
for file in "$@"; do
    # Check if file exists and is a regular file
    if [ -f "$file" ]; then
        # Check if ffmpeg is available
        if ! command -v ffmpeg &>/dev/null; then
            echo "Error: ffmpeg is not installed."
            echo "Install it with: sudo apt install ffmpeg"
            exit 1
        fi
        
        # Extract audio
        extract_audio "$file"
        processed_count=$((processed_count + 1))
    fi
    file_count=$((file_count + 1))
done

echo "=========================================="
echo "Processed $processed_count of $file_count files"
echo "Audio saved to: $OUTPUT_DIR"

# Show completion message
if [ $processed_count -gt 0 ]; then
    notify-send "Audio Extraction Complete" \
        "Extracted $processed_count MP3 file(s)\nQuality: 64k mono, 22.05kHz"
fi

# Keep terminal open for viewing (optional)
read -p "Press Enter to close..."
